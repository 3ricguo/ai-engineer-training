# 本地 RAG 问答系统 (Gradio & FastAPI)

## 项目概述

本项目是一个完整的、可本地运行的检索增强生成 (RAG) 解决方案。它基于 Gradio 和 FastAPI 构建了用户友好的 Web 界面，允许用户上传文档、创建向量知识库，并与自己的数据进行对话。系统底层使用 LlamaIndex 进行索引和检索，并集成阿里云通义千问 (DashScope) 以支持高性能的向量嵌入和语言模型推理。

## 主要功能

- **Web 界面:** 基于 Gradio 构建的图形化界面，易于上手，支持文件上传、知识库管理和智能问答。
- **多格式数据支持:** 可处理非结构化数据 (PDF, DOCX, TXT) 和结构化数据 (CSV, XLSX)。
- **持久化知识库:** 使用 LlamaIndex (FAISS 后端) 创建并保存多个向量知识库，方便长期使用。
- **即时 RAG:** 支持在聊天界面直接上传文件，进行一次性的临时对话。
- **两阶段检索:** 采用“粗排+精排”的检索策略，通过向量搜索初步筛选，再由可选的 DashScope reranker 模型进行重排序，提升检索精度。
- **可配置大语言模型:** 支持在运行时切换不同的通义千问模型 (如 `qwen-max`, `qwen-plus`)，并调整温度、最大Token等生成参数。
- **可解释性:** 在界面上会显示模型回答所参考的原文片段及其相似度分数，增强答案的可信度。

## 技术架构

- **后端服务:** FastAPI
- **前端界面:** Gradio
- **RAG 框架与索引:** LlamaIndex
- **向量嵌入 & 大语言模型:** 阿里云通义千问 (DashScope)
- **向量数据库:** FAISS (通过 LlamaIndex)

## 安装与设置

1.  **环境要求:** Python 3.9+

2.  **克隆仓库 (可选):**
    ```bash
    git clone <repository_url>
    cd week03-local-rag
    ```

3.  **创建虚拟环境:**
    ```bash
    python -m venv venv
    source venv/bin/activate  # Windows 系统请使用 `venv\Scripts\activate`
    ```

4.  **安装依赖:**
    ```bash
    pip install -r requirements.txt
    ```

5.  **设置环境变量:**
    您必须提供阿里云 DashScope 的 API 密钥。可以在项目根目录下创建一个 `.env` 文件，或将其设置为系统环境变量。

    **.env 文件内容示例:**
    ```
    DASHSCOPE_API_KEY="sk-xxxxxxxxxxxxxxxxxxxxxxxx"
    ```
    程序通过 `os.getenv("DASHSCOPE_API_KEY")` 加载此密钥。

## 运行程序

1.  **启动服务:**
    ```bash
    uvicorn main:app --host 0.0.0.0 --port 7866
    ```

2.  **访问界面:**
    打开浏览器并访问 `http://127.0.0.1:7866`。

## 使用指南

应用界面主要分为三个部分，可通过页面顶部的导航栏进入。

### 第一步: 上传数据 (`/upload_data`)

这是创建持久化知识库的第一步。

-   进入 **"上传数据"** 页面。
-   **非结构化数据 (PDF, DOCX 等):**
    1.  在 "非结构化数据" 标签页下，输入一个 "类目名称" 用于组织文件。
    2.  上传文件。
    3.  点击 **"新建类目"**。文件将被保存到 `File/Unstructured/<类目名称>` 目录下。
-   **结构化数据 (CSV, XLSX):**
    1.  在 "结构化数据" 标签页下，输入一个 "数据表名称"。
    2.  上传表格文件。
    3.  点击 **"新建数据表"**。系统会自动将表格的每一行转换为文本格式，并保存到 `File/Structured/<数据表名称>` 目录下。

### 第二步: 创建知识库 (`/create_knowledge_base`)

数据上传后，便可以创建可供检索的向量索引。

-   进入 **"创建知识库"** 页面。
-   选择对应的 "非结构化数据" 或 "结构化数据" 标签页。
-   在下拉菜单中选择第一步创建的类目或数据表。
-   输入一个独一无二的 "知识库名称"。
-   点击 **"确认创建知识库"**。
-   系统将开始处理文件，生成向量嵌入，并将索引保存在 `VectorStore/` 目录下。

### 第三步: RAG 问答 (`/chat`)

这是进行问答的主界面。

-   进入 **"RAG问答"** 页面。
-   **使用持久化知识库:** 在右侧的 **"加载知识库"** 下拉菜单中选择您已创建的知识库。
-   **使用临时文件:** 直接在底部的多模态输入框中上传一个或多个文件，系统将为本次会话创建一个临时知识库。
-   在输入框中提问。模型将利用知识库中的相关信息来生成回答。
-   您可以在右侧的折叠面板中调整模型 (`qwen-max` 等)、RAG (`召回片段数`, `相似度阈值`) 和生成 (`温度参数` 等) 的参数。

## 项目结构

```
.
├── File/                  # 存放上传的原始文件
│   ├── Structured/        # 存放处理后的结构化数据
│   └── Unstructured/      # 存放非结构化数据
├── VectorStore/           # 存放持久化的 FAISS 向量索引
├── images/                # 界面图片 (用户/机器人头像)
├── chat.py                # 核心 RAG 与聊天逻辑
├── create_kb.py           # 知识库创建逻辑
├── main.py                # FastAPI/Gradio 应用入口
├── upload_file.py         # 文件上传与处理逻辑
├── requirements.txt       # Python 依赖
└── README.md              # 本文档
```